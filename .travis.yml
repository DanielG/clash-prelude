language: c
sudo: false

matrix:
  include:
    - env: GHCVER=7.10.1 CABALVER=1.22 JOPTS="-j2"
      addons: {apt: {packages: [cabal-install-1.22,ghc-7.10.1],sources: [hvr-ghc]}}
    - env: GHCVER=7.10.2 CABALVER=1.22 JOPTS="-j2"
      addons: {apt: {packages: [cabal-install-1.22,ghc-7.10.2],sources: [hvr-ghc]}}
    - env: GHCVER=head CABALVER=head JOPTS="-j2"
      addons: {apt: {packages: [cabal-install-head,ghc-head],  sources: [hvr-ghc]}}

  allow_failures:
    - env: GHCVER=7.10.2 CABALVER=1.22 JOPTS="-j2"
    - env: GHCVER=head CABALVER=head JOPTS="-j2"

before_install:
  - export PATH=/opt/ghc/$GHCVER/bin:/opt/cabal/$CABALVER/bin:$PATH
  - export CABAL=cabal-$CABALVER
  - ghc --version
  - $CABAL --version
  - travis_retry $CABAL update

install:
  - $CABAL install $JOPTS --enable-tests --dependencies-only

script:
  - $CABAL configure -v2 --enable-tests
  - $CABAL build $JOPTS
  - $CABAL test --show-details=always

  # tests that a source-distribution can be generated
  - $CABAL sdist

  # check that the generated source-distribution can be built & installed
  - export SRC_TGZ=$($CABAL info . | awk '{print $2 ".tar.gz";exit}') ;
    if [ -f "dist/$SRC_TGZ" ]; then
       $CABAL install --force-reinstalls "dist/$SRC_TGZ";
    else
       echo "expected 'dist/$SRC_TGZ' not found";
       exit 1;
    fi

notifications:
  irc:
    channels:
      - "irc.freenode.org#clash-lang"
    skip_join: true
    template:
      - "\x0313clash-prelude\x0f/\x0306%{branch}\x0f \x0314%{commit}\x0f %{message} \x0302\x1f%{build_url}\x0f"
